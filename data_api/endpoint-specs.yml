- config:
    - testset: SMS 487 API
    - timeout: 1

- test:
    - name: Home page
    - url: /
    - headers:  {template: {'cookie': 'AUTH_TOKEN=$test_auth_token'}}
    - validators:
        - compare: {header: 'content-type', expected: 'text/html; charset=utf-8'}

- test:
    - name: Error 404 returns error message
    - url: /404
    - expected_status: 404
    - validators:
        - compare: {header: 'content-type', expected: 'application/json; charset=utf-8'}
        - extract_test: {jsonpath_mini: '0.error', test: 'exists'}
        - compare: {jsonpath_mini: '0.error', expected: 'Not found'}

- test:
    - name: Endpoint /get-sms
    - url: /get-sms
    - headers:  {template: {'cookie': 'AUTH_TOKEN=$test_auth_token'}}
    - validators:
        - compare: {header: 'content-type', expected: 'application/json; charset=utf-8'}
        - extract_test: {jsonpath_mini: '0.date_time', test: 'exists'}
        - extract_test: {jsonpath_mini: '0.tel', test: 'exists'}
        - extract_test: {jsonpath_mini: '0.device_id', test: 'exists'}
        - extract_test: {jsonpath_mini: '0.text', test: 'exists'}
        - compare: {jsonpath_mini: '0.date_time', expected: '01 Jan 2018 03:03'}
        - compare: {jsonpath_mini: '0.tel', expected: '000'}
        - compare: {jsonpath_mini: '0.device_id', expected: 'Test_3'}
        - compare: {jsonpath_mini: '0.text', expected: 'Baz'}

- test:
    - name: Endpoint /get-sms – incorrect limit
    - url: /get-sms?limit=qwerty
    - headers:  {template: {'cookie': 'AUTH_TOKEN=$test_auth_token'}}
    - expected_status: 400
    - validators:
        - compare: {header: 'content-type', expected: 'application/json; charset=utf-8'}
        - extract_test: {jsonpath_mini: '0.error', test: 'exists'}
        - compare: {jsonpath_mini: '0.error', expected: 'Incorrect limit'}

- test:
    - name: Endpoint /add-sms
    - url: /add-sms
    - method: POST
    - body: 'date_time=2018-01-01%2000%3A04%3A00%20%2B0000&tel=000&device_id=Test_4&text=Quux'
    - headers:
        - template: {cookie: 'AUTH_TOKEN=$test_auth_token'}
        - content-type: 'application/x-www-form-urlencoded'
    - auth_username: 'test-user'
    - auth_password: 'password'
    - validators:
        - compare: {header: 'content-type', expected: 'application/json; charset=utf-8'}
        - extract_test: {jsonpath_mini: '0.status', test: 'exists'}
        - compare: {jsonpath_mini: '0.status', expected: 'OK'}

- test:
    - name: Check added SMS
    - url: /get-sms
    - headers:  {template: {'cookie': 'AUTH_TOKEN=$test_auth_token'}}
    - validators:
        - compare: {header: 'content-type', expected: 'application/json; charset=utf-8'}
        - extract_test: {jsonpath_mini: '0.date_time', test: 'exists'}
        - extract_test: {jsonpath_mini: '0.tel', test: 'exists'}
        - extract_test: {jsonpath_mini: '0.device_id', test: 'exists'}
        - extract_test: {jsonpath_mini: '0.text', test: 'exists'}
        - compare: {jsonpath_mini: '0.date_time', expected: '01 Jan 2018 03:04'}
        - compare: {jsonpath_mini: '0.tel', expected: '000'}
        - compare: {jsonpath_mini: '0.device_id', expected: 'Test_4'}
        - compare: {jsonpath_mini: '0.text', expected: 'Quux'}

- test:
    - name: Endpoint /add-sms – wrong method (GET)
    - url: /add-sms
    - headers:  {template: {'cookie': 'AUTH_TOKEN=$test_auth_token'}}
    - expected_status: 405
    - validators:
        - compare: {header: 'content-type', expected: 'application/json; charset=utf-8'}
        - extract_test: {jsonpath_mini: '0.error', test: 'exists'}
        - compare: {jsonpath_mini: '0.error', expected: 'Method is not allowed'}

- test:
    - name: Endpoint /add-sms – no device ID
    - url: /add-sms
    - method: POST
    - body: 'date_time=2018-01-01%2000%3A04%3A00%20%2B0000&tel=000&text=Quux'
    - headers:
        - template: {cookie: 'AUTH_TOKEN=$test_auth_token'}
        - content-type: 'application/x-www-form-urlencoded'
    - auth_username: 'test-user'
    - auth_password: 'password'
    - expected_status: 400
    - validators:
        - compare: {header: 'content-type', expected: 'application/json; charset=utf-8'}
        - extract_test: {jsonpath_mini: '0.error', test: 'exists'}
        - compare: {jsonpath_mini: '0.error', expected: 'There is no device ID'}

- test:
    - name: Endpoint /add-sms – no tel
    - url: /add-sms
    - method: POST
    - body: 'date_time=2018-01-01%2000%3A04%3A00%20%2B0000&device_id=Test_4&text=Quux'
    - headers:
        - template: {cookie: 'AUTH_TOKEN=$test_auth_token'}
        - content-type: 'application/x-www-form-urlencoded'
    - expected_status: 400
    - validators:
        - compare: {header: 'content-type', expected: 'application/json; charset=utf-8'}
        - extract_test: {jsonpath_mini: '0.error', test: 'exists'}
        - compare: {jsonpath_mini: '0.error', expected: 'There is no tel'}

- test:
    - name: Endpoint /add-sms – no date_time
    - url: /add-sms
    - method: POST
    - body: 'tel=000&device_id=Test_4&text=Quux'
    - headers:
        - template: {cookie: 'AUTH_TOKEN=$test_auth_token'}
        - content-type: 'application/x-www-form-urlencoded'
    - expected_status: 400
    - validators:
        - compare: {header: 'content-type', expected: 'application/json; charset=utf-8'}
        - extract_test: {jsonpath_mini: '0.error', test: 'exists'}
        - compare: {jsonpath_mini: '0.error', expected: 'There is no date_time'}

- test:
    - name: Endpoint /add-sms – no text
    - url: /add-sms
    - method: POST
    - body: 'date_time=2018-01-01%2000%3A04%3A00%20%2B0000&tel=000&device_id=Test_4'
    - headers:
        - template: {cookie: 'AUTH_TOKEN=$test_auth_token'}
        - content-type: 'application/x-www-form-urlencoded'
    - expected_status: 400
    - validators:
        - compare: {header: 'content-type', expected: 'application/json; charset=utf-8'}
        - extract_test: {jsonpath_mini: '0.error', test: 'exists'}
        - compare: {jsonpath_mini: '0.error', expected: 'There is no text'}

- test:
    - name: Endpoint /get-sms – incorrect token
    - url: /get-sms
    - headers:  {template: {'cookie': 'AUTH_TOKEN=1$test_auth_token'}}
    - expected_status: 403

- test:
    - name: Endpoint /get-sms – np auth
    - url: /get-sms
    - expected_status: 302
    - validators:
        - compare: {header: 'content-type', expected: 'text/html; charset=utf-8'}
        - compare:
            header: 'location'
            expected:
              template: 'https://auth.andre.life?return-path=http%3A//127.0.0.1%3A$web_port/get-sms'
        - compare: {raw_body: '', comparator: 'contains', expected: 'Redirecting...'}

- test:
    - name: Endpoint /add-sms – incorrect token
    - url: /add-sms
    - method: POST
    - body: 'date_time=2018-01-01%2000%3A04%3A00%20%2B0000&tel=000&device_id=Test_4'
    - headers:
        - template: {cookie: 'AUTH_TOKEN=1$test_auth_token'}
        - content-type: 'application/x-www-form-urlencoded'
    - expected_status: 403

